<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Graph</title>
    <style>
        svg {
            border: 1px solid black;
        }
    </style>
</head>
<body>
<svg width="800" height="800"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-array.v1.min.js"></script>
<script src="https://d3js.org/d3-collection.v1.min.js"></script>
<script src="https://d3js.org/d3-color.v1.min.js"></script>
<script src="https://d3js.org/d3-format.v1.min.js"></script>
<script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
<script src="https://d3js.org/d3-scale.v2.min.js"></script>

<script>
    var nodesData = [
        {
            "key": "A_my",
            "authors": "A et al.",
            "title": "My first paper",
            "date-created": "2018-09-01",
            "referenced-n-times-global": 0,
            "referenced-n-times-local": 0,
            "year": 2
        },
        {
            "key": "B_friendly",
            "authors": "B et al.",
            "title": "Friendly paper",
            "date-created": "2018-04-23",
            "referenced-n-times-global": 5,
            "referenced-n-times-local": 0,
            "year": 2
        },
        {
            "key": "F_young",
            "authors": "F et al.",
            "title": "Young paper",
            "date-created": "2016-02-16",
            "referenced-n-times-global": 37,
            "referenced-n-times-local": 1,
            "year": 1
        },
        {
            "key": "C_another",
            "authors": "C et al.",
            "title": "Another friendly paper",
            "date-created": "2016-12-05",
            "referenced-n-times-global": 8,
            "referenced-n-times-local": 0,
            "year": 1
        },
        {
            "key": "D_old",
            "authors": "D et al.",
            "title": "Old paper",
            "date-created": "2013-04-01",
            "referenced-n-times-global": 236,
            "referenced-n-times-local": 2,
            "year": 0
        },
        {
            "key": "E_older",
            "authors": "E et al.",
            "title": "Older paper",
            "date-created": "2012-08-13",
            "referenced-n-times-global": 412,
            "referenced-n-times-local": 1,
            "year": 0
        }
    ];

    var linksData = [
        {"source": "A_my", "target": "D_old"},
        {"source": "B_friendly", "target": "D_old"},
        {"source": "B_friendly", "target": "E_older"},
        {"source": "C_another", "target": "F_young"},
    ];

    var minimumReferencedGlobal = Math.min.apply(Math, nodesData.map(function (p) {
        return p["referenced-n-times-global"];
    }));

    var maximumReferencedGlobal = Math.max.apply(Math, nodesData.map(function (p) {
        return p["referenced-n-times-global"];
    }));

    var minimumReferencedLocal = Math.min.apply(Math, nodesData.map(function (p) {
        return p["referenced-n-times-local"];
    }));

    var maximumReferencedLocal = Math.max.apply(Math, nodesData.map(function (p) {
        return p["referenced-n-times-local"];
    }));

    var nYears = Math.max.apply(Math, nodesData.map(function (p) {
        return p["year"];
    })) + 1;

    var minimumRadius = 50,
        maximumRadius = 20,
        colorMin = "white",
        colorMax = "red";

    var radiusScale = d3.scaleLog()
        .domain([minimumReferencedGlobal + 1, maximumReferencedGlobal + 1]) // must not be zero => + 1
        .range([minimumRadius, maximumRadius]);

    var colorScale = d3.scaleLinear()
        .domain([minimumReferencedLocal, maximumReferencedLocal])
        .range([colorMin, colorMax]);

    nodesData.forEach(function (p) {
        p.radius = radiusScale(p["referenced-n-times-global"] + 1);
    });

    var svg = d3.select("svg"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    var yearHeight = height / nYears;

    var force = d3.forceSimulation()
        .nodes(nodesData)
        .alpha(0.25)
        .alphaMin(0.01)
        .on('end', function () {
            force.force("collision_force", null);
            force.force("position_force_Y", null);
            force.force("position_force_X", null);
            force.force("link_force", null);
        })
    ;

    force
        .force("collision_force", d3.forceCollide(100).strength(1))
        .force("link_force", d3.forceLink(linksData)
            .id(function (d) {
                return d.key;
            })
            .strength(0.1))
        .force("position_force_Y", d3.forceY(function (d) {
            return yearHeight * (d.year + 0.5)
        }).strength(3))
        .force("position_force_X", d3.forceX(width / 2).strength(0.2))
    ;

    var link = svg.append("g")
        .attr("class", "links")
        .selectAll("line")
        .data(linksData)
        .enter()
        .append("line")
        .attr("stroke-width", 2)
        .style("stroke", function (l) {
            return colorScale(1);
        })
    ;

    var node = svg.append("g")
        .attr("class", "nodes")
        .selectAll("circle")
        .data(nodesData)
        .enter()
        .append("circle")
        .attr("r", function (p) {
            return p.radius;
        })
        .attr("fill", function (d) {
            return colorScale(d["referenced-n-times-local"]);
        })
        .attr("stroke", "black")
    ;

    force.on("tick", tickActions);

    function tickActions() {
        node
            .attr("cx", function (d) {
                return d.x = Math.max(d.radius, Math.min(width - d.radius, d.x));
            })
            .attr("cy", function (d) {
                var min_offset = yearHeight * d.year;
                var max_offset = yearHeight * (d.year + 1);
                return d.y = Math.max(d.radius + min_offset, Math.min(max_offset - d.radius, d.y));
            })
        ;

        link
            .attr("x1", function (d) {
                return d.source.x;
            })
            .attr("y1", function (d) {
                return d.source.y;
            })
            .attr("x2", function (d) {
                return d.target.x;
            })
            .attr("y2", function (d) {
                return d.target.y;
            })
        ;
    }

    var drag_handler = d3.drag()
        .on("start", drag_start)
        .on("drag", drag_drag)
        .on("end", drag_end);

    drag_handler(node);

    function drag_start(d) {
        if (!d3.event.active) force.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }

    function drag_drag(d) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

    function drag_end(d) {
        if (!d3.event.active) force.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
</script>
</body>
</html>
